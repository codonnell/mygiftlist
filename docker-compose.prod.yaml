version: '3.7'

services:
  postgres:
    image: postgres:12.1-alpine
    networks:
      - backend-private
    environment:
      POSTGRES_DB: mygiftlistrocks
      POSTGRES_USER_FILE: /run/secrets/db_user
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
    volumes:
      - db_data:/var/lib/postgresql/data
    secrets:
      - db_user
      - db_password

  backend:
    image: cpodonnell/mygiftlistrocks:latest
    networks:
      - traefik-public
      - backend-private
    depends_on:
      - postgres
    environment:
      JWK_ENDPOINT: "https://mygiftlistrocks.auth0.com/.well-known/jwks.json"
      PORT: "8080"
      POSTGRES_DB: mygiftlistrocks
      POSTGRES_USER_FILE: /run/secrets/db_user
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_user
      - db_password
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.backend.rule=Host(`mygiftlist.rocks`)"
        - "traefik.http.routers.backend.entrypoints=websecure"
        - "traefik.http.routers.backend.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.backend.loadbalancer.server.port=8080"

networks:
  traefik-public:
    external: true
  backend-private:
    external: false

secrets:
  db_user:
    external: true
  db_password:
    external: true

volumes:
  db_data:
